<!-- 0.0.7 !-->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>QR File Transfer v0.0.7 (Stable & Scannable)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{font-family:Arial;background:#0f172a;color:#e5e7eb;margin:0}
    header{padding:16px;background:#020617;display:flex;gap:12px}
    button{padding:10px 16px;border:none;border-radius:8px;cursor:pointer}
    .primary{background:#2563eb;color:#fff}
    .secondary{background:#334155;color:#fff}
    .panel{padding:20px;display:none}
    .panel.active{display:block}
    .box{background:#020617;padding:16px;border-radius:12px;margin-bottom:16px;max-width:560px}
    #qrBox{width:512px;height:512px;background:#fff;margin:auto}
    video{width:100%;max-width:420px;border-radius:12px;background:#000}
    .progress{width:100%;height:14px;background:#1e293b;border-radius:8px;overflow:hidden;margin-top:10px}
    .progress>div{height:100%;width:0%;background:#22c55e}
    .small{font-size:12px;opacity:.8}
  </style>
</head>
<body>
<header>
  <button class="primary" onclick="showPanel('send')">Send</button>
  <button class="secondary" onclick="showPanel('receive')">Receive</button>
</header>

<div id="send" class="panel active">
  <div class="box">
    <h2>Send (Step QR – Stable)</h2>
    <input type="file" id="fileInput" />
    <p class="small">Tap layar / tombol untuk QR berikutnya</p>
    <div id="qrBox"></div>
    <div class="progress"><div id="sendBar"></div></div>
    <p class="small" id="sendStatus">Idle</p>
  </div>
</div>

<div id="receive" class="panel">
  <div class="box">
    <h2>Receive (ZXing – Stable)</h2>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" hidden></canvas>
    <div class="progress"><div id="recvBar"></div></div>
    <p class="small" id="recvStatus">Menunggu QR...</p>
  </div>
</div>

<audio id="ding" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="></audio>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>

<script>
function showPanel(id){document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active')}

/* SEND */
const CHUNK = 350;
let frames = [], frameIndex = 0, qr;

fileInput.onchange = async () => {
  const f = fileInput.files[0]; if(!f) return;
  const b = new Uint8Array(await f.arrayBuffer()); frames = [];

  // META FRAME
  frames.push(JSON.stringify({type:'meta',name:f.name,size:b.length}));

  // DATA FRAMES
  for(let i=0;i<b.length;i+=CHUNK){
    const slice = b.slice(i,i+CHUNK);
    frames.push(JSON.stringify({type:'data',i:i/CHUNK,d:btoa(String.fromCharCode(...slice))}));
  }

  // END FRAME
  frames.push(JSON.stringify({type:'end'}));

  frameIndex = 0;
  qrBox.innerHTML='';
  qr = new QRCode(qrBox, { width:512, height:512, correctLevel: QRCode.CorrectLevel.Q });
  renderFrame();
};

function renderFrame(){
  qr.clear();
  qr.makeCode(frames[frameIndex]);
  sendStatus.textContent = `Frame ${frameIndex+1}/${frames.length}`;
  sendBar.style.width = Math.floor((frameIndex+1)/frames.length*100)+'%';
}

qrBox.onclick = () => {
  if(frameIndex < frames.length-1){ frameIndex++; renderFrame(); }
};

/* RECEIVE */
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const reader = new ZXing.BrowserQRCodeReader();

let recv = [], expectedSize = 0, fileName = 'received_file';

async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{exact:'environment'} } });
  video.srcObject = stream; await video.play();
}

function scan(){
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0);
    reader.decodeFromCanvas(canvas).then(r => {
      const o = JSON.parse(r.text);
      if(o.type === 'meta'){
        expectedSize = o.size; fileName = o.name;
        recvStatus.textContent = 'META diterima';
      }
      if(o.type === 'data' && recv[o.i] === undefined){
        recv[o.i] = o.d;
        const got = recv.filter(Boolean).length;
        recvBar.style.width = Math.floor(got/(expectedSize/CHUNK)*100)+'%';
        recvStatus.textContent = `Menerima ${got}`;
      }
      if(o.type === 'end') finish();
    }).catch(()=>{});
  }
  requestAnimationFrame(scan);
}

function finish(){
  const bytes = [];
  recv.forEach(b64 => { const s = atob(b64); for(let i=0;i<s.length;i++) bytes.push(s.charCodeAt(i)); });
  const blob = new Blob([new Uint8Array(bytes)]);
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fileName; a.click();
  ding.play(); recvStatus.textContent = 'Selesai';
}

document.body.addEventListener('click', async () => { await startCamera(); scan(); }, { once:true });
</script>
</body>
</html>
