<!-- V.0.1 !-->
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>VLC Black White Transfer v0.1.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#020617;color:#e5e7eb}
header{position:fixed;top:0;left:0;right:0;z-index:10;background:#020617;padding:12px;display:flex;gap:10px}
button{padding:10px 16px;border:none;border-radius:10px;cursor:pointer;font-size:14px}
.primary{background:#2563eb;color:#fff}
.secondary{background:#334155;color:#fff}
.panel{display:none;padding-top:80px;text-align:center}
.panel.active{display:block}
#txScreen{width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:bold}
video{width:92%;max-width:420px;border-radius:14px;background:#000}
canvas{display:none}
.info{font-size:13px;opacity:.85;margin-top:8px}
</style>
</head>
<body>
<header>
  <button class="primary" onclick="show('send')">Sender</button>
  <button class="secondary" onclick="show('recv')">Receiver</button>
</header>

<!-- SENDER -->
<div id="send" class="panel active">
  <input type="file" id="fileInput" />
  <div class="info">VLC Hitam/Putih • Manchester Encoding • Auto</div>
  <div id="txScreen">READY</div>
</div>

<!-- RECEIVER -->
<div id="recv" class="panel">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
  <div class="info" id="status">Menunggu kamera...</div>
</div>

<script>
function show(id){document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active')}

/* ================= SENDER ================= */
const txScreen = document.getElementById('txScreen');
let txBits = [], txIndex = 0, txTimer = null;
const BIT_TIME = 100; // ms (aman PC & Android)

fileInput.onchange = async () => {
  const f = fileInput.files[0]; if(!f) return;
  const bytes = new Uint8Array(await f.arrayBuffer());
  txBits = [];

  // PREAMBLE 10101010
  for(let i=0;i<8;i++) txBits.push(i%2);

  // DATA (Manchester encoded)
  bytes.forEach(b=>{
    for(let i=7;i>=0;i--){
      const bit = (b>>i)&1;
      // Manchester: 1 -> 10, 0 -> 01
      if(bit){ txBits.push(1,0); } else { txBits.push(0,1); }
    }
  });

  // END MARK 00000000
  for(let i=0;i<8;i++) txBits.push(0);

  txIndex = 0;
  startTx();
};

function startTx(){
  clearInterval(txTimer);
  txTimer = setInterval(()=>{
    const bit = txBits[txIndex];
    txScreen.style.background = bit ? '#ffffff' : '#000000';
    txScreen.style.color = bit ? '#000' : '#000';
    txScreen.textContent = bit ? '1' : '0';
    txIndex++;
    if(txIndex >= txBits.length){ clearInterval(txTimer); txScreen.textContent='DONE'; }
  }, BIT_TIME);
}

/* ================= RECEIVER ================= */
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');

let rxBits = [], rxBytes = [], syncBuf = '';
let receiving = false, manchesterBuf = '';

async function startCam(){
  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'} }, audio:false });
  video.srcObject = stream;
  await video.play();
  statusEl.textContent = 'Arahkan kamera ke layar sender';
  requestAnimationFrame(rxLoop);
}

function rxLoop(){
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0);

    const p = ctx.getImageData(canvas.width/2, canvas.height/2, 1, 1).data;
    const bit = (p[0] + p[1] + p[2]) > 380 ? 1 : 0;

    if(!receiving){
      syncBuf += bit;
      if(syncBuf.endsWith('10101010')){
        receiving = true;
        rxBits = [];
        rxBytes = [];
        manchesterBuf = '';
        statusEl.textContent = 'SYNC diterima';
      }
      if(syncBuf.length > 8) syncBuf = syncBuf.slice(-8);
    } else {
      manchesterBuf += bit;
      if(manchesterBuf.length === 2){
        if(manchesterBuf === '10') rxBits.push(1);
        else if(manchesterBuf === '01') rxBits.push(0);
        manchesterBuf = '';

        if(rxBits.length === 8){
          const byte = rxBits.reduce((a,b)=> (a<<1)|b, 0);
          if(byte === 0){ finish(); receiving = false; }
          else rxBytes.push(byte);
          rxBits = [];
          statusEl.textContent = 'Byte diterima: ' + rxBytes.length;
        }
      }
    }
  }
  requestAnimationFrame(rxLoop);
}

function finish(){
  const blob = new Blob([new Uint8Array(rxBytes)]);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'received.bin';
  a.click();
  statusEl.textContent = 'Transfer selesai';
}

setTimeout(startCam, 600);
</script>
</body>
</html>
