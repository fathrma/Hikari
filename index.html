<!-- 0.0.6 !-->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>QR File Transfer v0.0.6 (ZXing WASM)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{font-family:Arial;background:#0f172a;color:#e5e7eb;margin:0}
    header{padding:16px;background:#020617;display:flex;gap:12px}
    button{padding:10px 16px;border:none;border-radius:8px;cursor:pointer}
    .primary{background:#2563eb;color:#fff}
    .secondary{background:#334155;color:#fff}
    .panel{padding:20px;display:none}
    .panel.active{display:block}
    .box{background:#020617;padding:16px;border-radius:12px;margin-bottom:16px;max-width:520px}
    #qrBox{width:320px;height:320px;background:#fff;display:flex;align-items:center;justify-content:center}
    video{width:100%;max-width:420px;border-radius:12px;background:#000}
    select,input{padding:8px;border-radius:8px;border:none}
    .progress{width:100%;height:14px;background:#1e293b;border-radius:8px;overflow:hidden}
    .progress>div{height:100%;width:0%;background:#22c55e;transition:width .1s linear}
    .small{font-size:12px;opacity:.8}
  </style>
</head>
<body>
<header>
  <button class="primary" onclick="showPanel('send')">Send</button>
  <button class="secondary" onclick="showPanel('receive')">Receive</button>
</header>

<div id="send" class="panel active">
  <div class="box">
    <h2>Send (QR Continuous)</h2>
    <input type="file" id="fileInput" />
    <div id="qrBox"></div>
    <div class="progress"><div id="sendBar"></div></div>
    <p class="small" id="sendStatus">Idle</p>
  </div>
</div>

<div id="receive" class="panel">
  <div class="box">
    <h2>Receive (ZXing) â€” v0.0.6</h2>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" hidden></canvas>
    <div class="progress"><div id="recvBar"></div></div>
    <p class="small" id="recvStatus">Menunggu QR...</p>
  </div>
</div>

<audio id="ding" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="></audio>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>

<script>
function showPanel(id){document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active')}

/* SEND */
const CHUNK=700;let chunks=[],idx=0,qr;
fileInput.onchange=async()=>{
  const f=fileInput.files[0];if(!f)return;
  const b=new Uint8Array(await f.arrayBuffer());chunks=[];
  for(let i=0;i<b.length;i+=CHUNK){chunks.push(btoa(String.fromCharCode(...b.slice(i,i+CHUNK))))}
  idx=0;qrBox.innerHTML='';qr=new QRCode(qrBox,{width:320,height:320});
  const timer=setInterval(()=>{
    if(idx>=chunks.length){clearInterval(timer);sendStatus.textContent='Selesai';sendBar.style.width='100%';return}
    const payload=JSON.stringify({i:idx,t:chunks.length,d:chunks[idx]});
    qr.clear();qr.makeCode(payload);
    idx++;sendBar.style.width=Math.floor(idx/chunks.length*100)+'%'
  },600);
}

/* RECEIVE ZXing */
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const reader=new ZXing.BrowserQRCodeReader();
let recv=[],total=null;

async function startCamera(){
  if(video.srcObject){video.srcObject.getTracks().forEach(t=>t.stop())}
  const stream=await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:{exact:'environment'},
      width:{ideal:1280},
      height:{ideal:720}
    }
  })
  video.setAttribute('playsinline','true')
  video.muted=trues
  video.srcObject=stream
  await video.play()
}


function scan(){
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    canvas.width=video.videoWidth;canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0);
    reader.decodeFromCanvas(canvas).then(r=>{
      const o=JSON.parse(r.text);
      if(!recv[o.i]){recv[o.i]=o.d;total=o.t;
        const got=recv.filter(Boolean).length;
        recvBar.style.width=Math.floor(got/total*100)+'%';
        recvStatus.textContent=`Menerima ${got}/${total}`}
      if(total&&recv.filter(Boolean).length===total)finish();
    }).catch(()=>{});
  }
  requestAnimationFrame(scan)
}

function finish(){
  const arr=[];recv.forEach(b=>{const s=atob(b);for(let i=0;i<s.length;i++)arr.push(s.charCodeAt(i))});
  const blob=new Blob([new Uint8Array(arr)]);
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='received_file';a.click();
  ding.play();recvStatus.textContent='Selesai';
}

// user gesture required
document.body.addEventListener('click',async()=>{await startCamera();scan()},{once:true});
</script>
</body>
</html>
